<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Maps - จำกัดพื้นที่เลือกจุด</title>
    <style>
        #map {
            height: 500px;
            width: 100%;
        }
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            text-align: center;
        }
        .popup button {
            margin: 5px;
            padding: 8px 12px;
            border: none;
            cursor: pointer;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 999;
        }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDT2NGc38xytYGpxqMSxADbiVA7WmDRjro&libraries=geometry&callback=initMap" async defer></script>
</head>
<body>
    <h2>เลือกจุดเริ่มต้นและปลายทาง (พื้นที่นอกเป็นสีดำ)</h2>
    <div id="map"></div>

    <div class="overlay" id="overlay"></div>
    <div class="popup" id="popup">
        <p>เลือกประเภทตำแหน่ง:</p>
        <button onclick="setStart()">ต้นทาง</button>
        <button onclick="setEnd()">ปลายทาง</button>
        <button onclick="closePopup()">ยกเลิก</button>
    </div>

    <script>
        let map;
        let startMarker = null, endMarker = null;
        let startPos = null, endPos = null;
        let directionsService, directionsRenderer;
        let clickPos = null;

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 13.7563, lng: 100.5018 }, // กรุงเทพฯ
                zoom: 12,
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({ map: map });

            // พื้นที่ที่เลือกได้
            const allowedBounds = [
                { lat: 13.730, lng: 100.480 },
                { lat: 13.730, lng: 100.520 },
                { lat: 13.770, lng: 100.520 },
                { lat: 13.770, lng: 100.480 }
            ];

            // พื้นที่ที่ไม่สามารถเลือกได้ (สีดำ)
            const maskPolygon = new google.maps.Polygon({
                paths: allowedBounds, // ใช้ "allowedBounds" สำหรับพื้นที่ที่เลือกได้
                strokeOpacity: 0,
                fillColor: "#000000", // พื้นที่ที่ไม่สามารถเลือกได้
                fillOpacity: 0.7,
                map: map
            });

            // ตรวจสอบเมื่อคลิกบนแผนที่
            google.maps.event.addListener(map, "click", function(event) {
                if (google.maps.geometry.poly.containsLocation(event.latLng, maskPolygon)) {
                    clickPos = event.latLng;
                    openPopup(); // เปิดป๊อปอัปเมื่อคลิกในพื้นที่ที่เลือกได้
                } else {
                    alert("กรุณาเลือกจุดในพื้นที่ที่กำหนด!");
                }
            });
        }

        function openPopup() {
            document.getElementById("overlay").style.display = "block";
            document.getElementById("popup").style.display = "block";
        }

        function closePopup() {
            document.getElementById("overlay").style.display = "none";
            document.getElementById("popup").style.display = "none";
        }

        function setStart() {
            if (startMarker) startMarker.setMap(null);
            startMarker = new google.maps.Marker({
                position: clickPos,
                map: map,
                label: "S",
                animation: google.maps.Animation.DROP
            });
            startPos = clickPos;
            closePopup();
            calculateRoute();
        }

        function setEnd() {
            if (endMarker) endMarker.setMap(null);
            endMarker = new google.maps.Marker({
                position: clickPos,
                map: map,
                label: "E",
                animation: google.maps.Animation.DROP
            });
            endPos = clickPos;
            closePopup();
            calculateRoute();
        }

        function calculateRoute() {
            if (!startPos || !endPos) return;

            directionsService.route(
                {
                    origin: startPos,
                    destination: endPos,
                    travelMode: google.maps.TravelMode.DRIVING
                },
                (response, status) => {
                    if (status === "OK") {
                        directionsRenderer.setDirections(response);
                        const distance = response.routes[0].legs[0].distance.text;
                        alert(`ระยะทาง: ${distance}`);
                    } else {
                        alert("ไม่สามารถคำนวณเส้นทางได้!");
                    }
                }
            );
        }
    </script>
</body>
</html>
